<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Clash Royale Global Scoreboard</title>
<style>
:root{--bg:#0f1221;--card:#151935;--muted:#9aa0b4;--fg:#eaeaf2;--accent:#6ea8fe}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#0d1020 0%,#0f1221 100%);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.container{max-width:980px;margin:32px auto;padding:0 16px}
h1{font-size:28px;margin:0 0 16px}
.topbar{display:grid;grid-template-columns:1fr auto 1fr auto 1.2fr auto;gap:12px;align-items:center;margin-bottom:20px}
.input{background:var(--card);border:1px solid #222748;border-radius:10px;padding:10px 12px;color:var(--fg);outline:none;min-width:140px}
.button{background:var(--accent);border:none;border-radius:10px;color:#0b1023;padding:10px 14px;font-weight:700;cursor:pointer;transition:transform .06s ease}
.button:active{transform:translateY(1px)}
.button.secondary{background:#222748;color:var(--fg)}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px}
.card{background:var(--card);border:1px solid #222748;border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:12px}
.row{display:flex;justify-content:space-between;gap:8px;align-items:center}
.vs{font-weight:800;letter-spacing:.3px}
.name{font-weight:700}
.score{font-size:34px;font-weight:900}
.controls{display:flex;gap:8px}
.small{font-size:12px;color:var(--muted)}
.badge{font-size:11px;border:1px solid #2a2f47;border-radius:999px;padding:4px 8px;color:var(--muted)}
.badge.ok{color:#0a1b12;border-color:#1a3a2a;background:rgba(101,212,140,.18)}
.badge.wait{color:#1a203a;border-color:#2a2f47;background:rgba(110,168,254,.16)}
.badge.warn{color:#2b0e11;border-color:#3a1a1e;background:rgba(240,113,120,.2)}
.toolbar{display:flex;gap:6px;flex-wrap:wrap}
hr{border:none;border-top:1px solid #232845;margin:18px 0}
footer{margin:20px 0;color:var(--muted);font-size:12px;text-align:center}
#empty{opacity:.8;text-align:center;padding:40px;border:1px dashed #2a2f47;border-radius:14px}
input[type="search"]{grid-column:1/-1}
.hidden{display:none}
#toastBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);opacity:0;pointer-events:none;transition:opacity .15s ease;z-index:9998}
#toastBackdrop.show{opacity:1;pointer-events:auto}
#toast{
  position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
  background:#0f1330;border:1px solid #445; color:var(--fg);
  padding:18px 22px;border-radius:14px;box-shadow:0 18px 60px rgba(0,0,0,.5);
  opacity:0;pointer-events:none;transition:opacity .15s ease;max-width:92vw;text-align:center;z-index:9999;
  font-size:16px;line-height:1.25
}
#toast.show{opacity:1}
.toast-title{display:block;font-weight:900;margin-bottom:8px;font-size:18px}
.subtitle{font-size:13px;color:var(--muted)}
.title{font-weight:700}
.button.disabled-look{opacity:.55;filter:saturate(.4);cursor:not-allowed}
</style>
</head>
<body>
<div class="container">
  <h1>Clash Royale Global Scoreboard</h1>
  <div class="topbar">
    <input id="a" class="input" placeholder="Player A" />
    <span class="small">vs</span>
    <input id="b" class="input" placeholder="Player B" />
    <span class="small">mode/title</span>
    <input id="t" class="input" placeholder="e.g. Ladder / 2v2 / Draft" />
    <button id="add" class="button">Add Matchup</button>
    <input id="search" class="input" type="search" placeholder="Search matchups" />
  </div>
  <div id="empty" class="small">No matchups yet. Add one above.</div>
  <div id="list" class="grid"></div>
  <hr />
  <footer>A Kushal Sachdeva Production</footer>
</div>
<div id="toastBackdrop"></div>
<div id="toast"></div>

<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyClcpvLfQy4OiiuDhAUxOFqqUgst474tAA",
    authDomain: "clashroyalescore-362e0.firebaseapp.com",
    projectId: "clashroyalescore-362e0",
    storageBucket: "clashroyalescore-362e0.firebasestorage.app",
    messagingSenderId: "764219519441",
    appId: "1:764219519441:web:454f203bcdb3efd3e2b0f0",
    measurementId: "G-1NK8D02HTF"
  };
  firebase.initializeApp(firebaseConfig);
  const db=firebase.firestore();

  const SCORE_COOLDOWN_MS=120000;   // 2 minutes
  const RESET_COOLDOWN_MS=600000;   // 10 minutes
  const DELETE_COOLDOWN_MS=600000;  // 10 minutes (delete)

  const $=q=>document.querySelector(q);
  const $$=q=>document.querySelectorAll(q);
  const human=ms=>{const s=Math.ceil(ms/1000);const m=Math.floor(s/60);const r=s%60;return m?`${m}m ${r}s`:`${r}s`};
  const coll=()=>db.collection('matchups');
  const toast=(msg, title)=>{const el=$('#toast');const bg=$('#toastBackdrop');el.innerHTML=title?`<span class="toast-title">${title}</span>${msg}`:msg;bg.classList.add('show');el.classList.add('show');clearTimeout(window.__toastT);window.__toastT=setTimeout(()=>{el.classList.remove('show');bg.classList.remove('show')},3000)}

  const addMatchup=async()=>{
    const a=$('#a').value.trim(),b=$('#b').value.trim(),title=$('#t').value.trim();
    if(!a||!b)return toast('Enter both player names');
    await coll().add({a,b,title,sa:0,sb:0,created:firebase.firestore.FieldValue.serverTimestamp(),lastUpdate:null,lastReset:null,lastDelete:null});
    $('#a').value='';$('#b').value='';$('#t').value='';
  };

  const remainingScore=(d)=>{
    const last=d.lastUpdate?d.lastUpdate.toMillis():0;return Math.max(0,SCORE_COOLDOWN_MS-(Date.now()-last));
  }
  const remainingReset=(d)=>{
    const last=d.lastReset?d.lastReset.toMillis():0;return Math.max(0,RESET_COOLDOWN_MS-(Date.now()-last));
  }
  const remainingDelete=(d)=>{
    const last=d.lastDelete?d.lastDelete.toMillis():0;
    const createdMs=d.created? (d.created.toMillis? d.created.toMillis() : d.created) : 0;
    return Math.max(0,DELETE_COOLDOWN_MS-(Date.now()-last),DELETE_COOLDOWN_MS-(Date.now()-createdMs));
  }

  const bump=async(id,side)=>{
    const ref=coll().doc(id);
    const snap=await ref.get();
    const d=snap.data();
    const rem=remainingScore(d);
    if(rem>0){toast(`2 min cooldown — ${human(rem)} left (anti‑tampering)`);return;}
    await db.runTransaction(async(tx)=>{
      const s=await tx.get(ref); if(!s.exists) throw new Error('missing');
      const cur=s.data();
      const incA=side==='a'?1:0; const incB=side==='b'?1:0;
      tx.update(ref,{sa:cur.sa+incA,sb:cur.sb+incB,lastUpdate:firebase.firestore.FieldValue.serverTimestamp()});
    }).catch(e=>toast(e.message));
  };

  const reset=async(id)=>{
    const ref=coll().doc(id);
    const snap=await ref.get();
    const d=snap.data();
    const rem=remainingReset(d);
    if(rem>0){toast(`Reset has 10 min cooldown — ${human(rem)} left (anti‑tampering)`);return;}
    await db.runTransaction(async(tx)=>{
      const s=await tx.get(ref); if(!s.exists) throw new Error('missing');
      tx.update(ref,{sa:0,sb:0,lastUpdate:null,lastReset:firebase.firestore.FieldValue.serverTimestamp()});
    }).catch(e=>toast(e.message));
  };

  const remove=async(id)=>{
    const ref=coll().doc(id);
    const snap=await ref.get();
    const d=snap.data();
    const rem=remainingDelete(d);
    if(rem>0){toast(`Delete has 10 min cooldown — ${human(rem)} left (anti‑tampering)`);return;}
    if(!confirm('Delete this matchup?'))return;
    await ref.delete();
  };

  const rename=async(id,side,name)=>{if(!name||!name.trim())return;await coll().doc(id).update(side==='a'?{a:name.trim()}:{b:name.trim()});};

  const card=(it)=>{
    const scoreRem = remainingScore(it);
    const scoreReady = scoreRem === 0;

    const rSt = resetState(it);
    const dSt = deleteState(it);

    const resetBadge = !rSt.armed
      ? `<span class="badge">Reset: Tap to arm</span>`
      : (rSt.ready
          ? `<span class="badge ok">Reset: Ready to confirm</span>`
          : `<span class="badge wait">Reset: Armed — Wait ${human(rSt.rem)}</span>`);

    const deleteBadge = !dSt.armed
      ? `<span class="badge">Delete: Tap to arm</span>`
      : (dSt.ready
          ? `<span class="badge ok">Delete: Ready to confirm</span>`
          : `<span class="badge wait">Delete: Armed — Wait ${human(dSt.rem)}</span>`);

    const lead = it.sa === it.sb ? 'Tied' : (it.sa > it.sb ? `${it.a} leading` : `${it.b} leading`);

    return `
    <div class="card" data-id="${it.id}">
      <div class="row">
        <div>
          <div class="vs">
            <span class="name editable" data-side="a">${it.a}</span> vs
            <span class="name editable" data-side="b">${it.b}</span>
          </div>
          ${it.title ? `<div class="subtitle">${it.title}</div>` : ''}
        </div>
        <div class="toolbar">
          <span class="badge">${lead}</span>
          ${scoreReady ? `<span class="badge ok">Score: Ready</span>` : `<span class="badge wait">Score: Wait ${human(scoreRem)}</span>`}
          ${resetBadge}
          ${deleteBadge}
        </div>
      </div>
      <div class="row">
        <div class="score">${it.sa} : ${it.sb}</div>
        <div class="controls">
          <button class="button ${scoreReady?"":"disabled-look"}" data-action="plusA">+1 ${it.a}</button>
          <button class="button ${scoreReady?"":"disabled-look"}" data-action="plusB">+1 ${it.b}</button>
        </div>
      </div>
      <div class="row">
        <div class="small">Last score add: ${it.lastUpdate ? it.lastUpdate.toDate().toLocaleString() : "—"}</div>
        <div class="controls">
          <button class="button secondary" data-action="reset">Reset</button>
          <button class="button secondary" data-action="delete">Delete</button>
        </div>
      </div>
    </div>`
  };

  let unsubscribe=null;
  const render=(docs)=>{
    const q=$('#search').value.trim().toLowerCase();
    const items=docs.filter(x=>!q||x.a.toLowerCase().includes(q)||x.b.toLowerCase().includes(q)||(x.title||'').toLowerCase().includes(q));
    $('#list').innerHTML=items.map(card).join('');
    $('#empty').style.display=items.length?'none':'block';
    $$('#list .card').forEach(el=>{
      const id=el.getAttribute('data-id');
      el.querySelector('[data-action="plusA"]').addEventListener('click',()=>bump(id,'a'));
      el.querySelector('[data-action="plusB"]').addEventListener('click',()=>bump(id,'b'));
      el.querySelector('[data-action="reset"]').addEventListener('click',()=>reset(id));
      el.querySelector('[data-action="delete"]').addEventListener('click',()=>remove(id));
      el.querySelectorAll('.editable').forEach(n=>{
        n.addEventListener('click',()=>{const side=n.getAttribute('data-side');const next=prompt('Rename',n.textContent);if(next)rename(id,side,next)});
      });
    });
  };

  const listen=()=>{
    if(unsubscribe)unsubscribe();
    unsubscribe=coll().orderBy('created','desc').onSnapshot(snap=>{
      const docs=[];
      snap.forEach(d=>{const x=d.data();docs.push({id:d.id,a:x.a,b:x.b,title:x.title||'',sa:x.sa,sb:x.sb,created:x.created?x.created:0,lastUpdate:x.lastUpdate||null,lastReset:x.lastReset||null,lastDelete:x.lastDelete||null});});
      render(docs);
    });
  };

  $('#add').addEventListener('click',addMatchup);
  $('#a,#b,#t').addEventListener('keydown',e=>{if(e.key==='Enter')addMatchup()});
  $('#search').addEventListener('input',listen);
  listen();
  setInterval(listen,1000);
</script>
</body>
</html>
